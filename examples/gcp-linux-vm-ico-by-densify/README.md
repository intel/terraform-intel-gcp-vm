<p align="center">
  <img src="https://github.com/intel/terraform-intel-gcp-vm/blob/main/images/logo-classicblue-800px.png?raw=true" alt="Intel Logo" width="250"/>
</p>

# Intel Cloud Optimization Modules for Terraform

© Copyright 2023, Intel Corporation

## Intel GCP Linux VM on default network using Intel Cloud Optimzier(ICO) by Densify recommendations
 
<p align="center">
  <img src="https://github.com/intel/terraform-intel-gcp-vm/blob/main/images/azure-vm-ico.png?raw=true" alt="Intel + Densify Logo" width="250"/>
</p>


This module creates a Linux VM on the default network named "ico-test" from sizing values in the densify_recommendations map. 
Using this example requires a "densify_recommndations.auto.tfvars" file. You are expected to generate this file so this is a sample file only. 
The sample densify_recommendations map found in this directory is in the same format that Densify would provide. 

Intel® Cloud Optimizer is a collaboration between Densify and Intel targeted at getting you the most from your cloud investment. 
Intel Cloud Optimizer by Densify helps customers optimize their cloud investments and ensure optimal performance for every workload.
Intel Cloud Optimizer by Densify is a commercial product. With Intel® Cloud Optimizer, Intel funds the use of Densify for qualifying enterprises for 12 months. For full details of the Intel Cloud Optimizer by Densify offer please see: [INTEL CLOUD OPTIMIZER by DENSIFY](https://www.densify.com/product/intel/)

Update the project with a your project id in GCP. It is located on the variables.tf file under this example folder for "GCP-Linux-VM-ICO-by-Densify"

## Usage

**See examples folder for complete examples.**

variables.tf

```hcl
variable "project" {
  type        = string
  description = "The ID of the project in which the resource resides."
}

#Name of the system.
variable "name" {
  default = "ico-test"
}
variable "densify_recommendations" {
  type = map(map(string))
  #sample map of map this would be generated by densify provided as a .auto.tfvars file that would have all the systems and info listed. 
  #In the file there would be multiple systems defined in this case it just has 1 called "ico-test". 
  #To see how it would work you can change the approvalType from all to na. As all assumes you have approved all changes and na would be used to say haven't approved the change and just want to make the system self-aware. 
  default = { 
    ico-test = {
      currentType = "n1-standard-2"
      recommendedType = "c3-standard-4"
      approvalType = "all"
      savingsEstimate = "26.6"
      predictedUptime = "94.32"
      reservedInstanceCoverage = "yes"
    }
  }
}

# Defaults this is used for fallback if the system name isn't found in the densify_recommendations. 
# This shouldn't be used in most cases likely use would be if you were to create a new system that hasn't been analyzed by Densify yet.
variable "densify_fallback"{
  type = map(string)
  default = {
	currentType = "n1-standard-2"
	recommendedType = "c3-standard-4"
  approvalType = "all"
	savingsEstimate = "0"
	predictedUptime = "0"
	reservedInstanceCoverage = "no"
  }
}

```

main.tf
```hcl
# You will need to provide value of the variable project, which is your GCP project id when you do terraform apply

# ICO by Densify module
module "densify" {
  source  = "densify-dev/optimization-as-code/null"
  densify_recommendations = var.densify_recommendations
  densify_fallback = var.densify_fallback
  # In this sample we are using the system name as the unique idenifier but if you had multiple systems that had the same name this should be set uniquely to make sure the correct recommendations are set\applied for each system.
  densify_unique_id = var.name
}

# Intel module
# Provision GCP Xeon 4th Generation Scalable processors (code-named Sapphire Rapids) VM
# You will need to provide value of the variable project, which is your GCP project id when you do terraform apply
module "linux_vm" {
  source              = "intel/gcp-vm/intel"
  project             = var.project
  boot_image_family   = "ubuntu-2204-lts"
  name                = var.name
  access_config = [{
    nat_ip                 = null
    public_ptr_domain_name = null
    network_tier           = "PREMIUM"
  }, ]

  # ICO by Densify - normal way of sizing an instance by hardcoding the size.
  #machine_type = "n1-standard-2"

  # ICO by Densify - new self-optimizing instance type from Densify
  machine_type = module.densify.instance_type
  
 }
```



Run Terraform

```hcl
terraform init  
terraform plan
terraform apply -var="project=<your_your_gcp_project_id>" 
```

## Considerations
Add additional considerations here:
- The GCP zone can be updated in the providers.tf file under this example folder for "GCP-Linux-VM-ICO-by-Densify"
- Update the project with a your project id in GCP. It is located on the variables.tf file under this example folder for "GCP-Linux-VM-ICO-by-Densify"
- The VM is created using the default network in the GCP zone configured in the providers.tf file. Please make sure you have a default network in the GCP zone of your choice
